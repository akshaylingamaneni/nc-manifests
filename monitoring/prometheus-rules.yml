apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
  namespace: monitoring
data:
  alerts.yml: |
    groups:
      - name: node-alerts
        rules:
          - alert: HighNodeCPU
            expr: 100 - (avg by(instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage on {{ $labels.instance }}"
              description: "CPU usage above 85% for 5 minutes (current: {{ $value }}%)"

          - alert: HighNodeMemory
            expr: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 > 85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage on {{ $labels.instance }}"
              description: "Memory usage above 85% for 5 minutes (current: {{ $value }}%)"

          - alert: HighNodeDisk
            expr: (1 - node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 > 85
            labels:
              severity: critical
            annotations:
              summary: "High disk usage on {{ $labels.instance }}"
              description: "Disk usage above 85% (current: {{ $value }}%)"

      - name: pod-alerts
        rules:
          - alert: PodCrashLooping
            expr: increase(kube_pod_container_status_restarts_total[15m]) > 5
            labels:
              severity: critical
            annotations:
              summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} crash looping"
              description: "Pod has restarted {{ $value }} times in 15 minutes"

          - alert: PodNotReady
            expr: kube_pod_status_ready{condition="true"} == 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.namespace }}/{{ $labels.pod }} not ready"
              description: "Pod has been not ready for 5 minutes"

      - name: target-alerts
        rules:
          - alert: TargetDown
            expr: up == 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Target {{ $labels.job }}/{{ $labels.instance }} down"
              description: "Target has been down for 5 minutes"
