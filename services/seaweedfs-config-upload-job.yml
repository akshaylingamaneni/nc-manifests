apiVersion: batch/v1
kind: Job
metadata:
  name: seaweedfs-s3-config-upload
  namespace: services
spec:
  ttlSecondsAfterFinished: 86400  # Clean up after 24 hours
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: upload-config
        image: curlimages/curl:latest
        command:
        - /bin/sh
        - -c
        - |
          # Upload config to each filer pod individually
          for filer in seaweedfs-filer-0 seaweedfs-filer-1; do
            echo "Waiting for $filer to be ready..."
            until curl -s http://${filer}.seaweedfs-filer-peer.services:8888/ | grep -q "SeaweedFS"; do
              echo "Waiting for $filer..."
              sleep 3
            done
            
            echo "Uploading S3 config to $filer..."
            curl -X PUT http://${filer}.seaweedfs-filer-peer.services:8888/etc/s3/config \
              -H "Content-Type: application/json" \
              -d @/config/seaweedfs_s3_config.json \
              -v
            
            echo "S3 config uploaded to $filer successfully!"
          done
          
          echo "All filers configured!"
        volumeMounts:
        - name: s3-config
          mountPath: /config
          readOnly: true
      volumes:
      - name: s3-config
        secret:
          secretName: seaweedfs-secrets
          items:
          - key: seaweedfs_s3_config.json
            path: seaweedfs_s3_config.json
